<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB完全統合版 (スタンドアロン)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7fa;
            margin: 0;
            padding: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        h1 {
            color: #1a365d;
            margin-bottom: 30px;
            font-weight: 700;
            text-align: center;
            border-bottom: 2px solid #3182ce;
            padding-bottom: 15px;
        }
        
        .status-card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .status-header {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            color: #1a365d;
            display: flex;
            align-items: center;
        }
        
        .status-header i {
            margin-right: 10px;
            font-size: 20px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            background-color: #f8fafc;
        }
        
        .status-icon {
            width: 20px;
            margin-right: 10px;
            text-align: center;
        }
        
        .success-icon {
            color: #38a169;
        }
        
        .pending-icon {
            color: #d69e2e;
        }
        
        .error-icon {
            color: #e53e3e;
        }
        
        .feature-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .feature-card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        
        .feature-header {
            background-color: #3182ce;
            color: white;
            padding: 15px 20px;
            font-weight: 500;
            font-size: 18px;
            display: flex;
            align-items: center;
        }
        
        .feature-header i {
            margin-right: 10px;
        }
        
        .feature-content {
            padding: 20px;
        }
        
        .feature-description {
            margin-bottom: 20px;
            color: #555;
        }
        
        .action-button {
            display: inline-block;
            background-color: #3182ce;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        
        .action-button:hover {
            background-color: #2b6cb0;
        }
        
        .db-status {
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .db-status i {
            margin-right: 8px;
        }
        
        .db-status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .db-status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .db-status.pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .action-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .log-container {
            height: 200px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            font-family: monospace;
            font-size: 14px;
            margin-top: 20px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
            border-bottom: 1px solid #eee;
        }
        
        .info { color: #0056b3; }
        .warning { color: #ff9800; }
        .error-text { color: #dc3545; }
        
        @media (max-width: 768px) {
            .feature-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MongoDB完全統合版 (スタンドアロン)</h1>
        
        <div class="status-card">
            <div class="status-header">
                <i class="fas fa-database"></i> MongoDB接続状態
            </div>
            
            <div id="db-status" class="db-status pending">
                <i class="fas fa-spinner fa-spin"></i> データベース接続状態を確認中...
            </div>
            
            <div id="status-details">
                <!-- ここに接続詳細が表示されます -->
            </div>
            
            <div class="action-buttons">
                <button id="test-connection" class="action-button">
                    <i class="fas fa-vial"></i> 接続テスト
                </button>
                <button id="show-details" class="action-button">
                    <i class="fas fa-info-circle"></i> 詳細表示
                </button>
            </div>
            
            <div id="log-container" class="log-container">
                <!-- ログがここに表示されます -->
            </div>
        </div>
        
        <div class="feature-cards">
            <div class="feature-card">
                <div class="feature-header">
                    <i class="fas fa-qrcode"></i> QRコード注文
                </div>
                <div class="feature-content">
                    <div class="feature-description">
                        QRコードを使った注文システム。カメラでQRコードをスキャンして商品を注文できます。MongoDB連携済み。
                    </div>
                    <a href="qr_mongo_order_new.html" class="action-button">開く</a>
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-header">
                    <i class="fas fa-shopping-cart"></i> 注文管理
                </div>
                <div class="feature-content">
                    <div class="feature-description">
                        商品の注文管理システム。テーブル別の注文状況確認や注文処理ができます。MongoDB連携済み。
                    </div>
                    <a href="index.html" class="action-button">開く</a>
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-header">
                    <i class="fas fa-edit"></i> 商品管理
                </div>
                <div class="feature-content">
                    <div class="feature-description">
                        商品マスターの管理画面。商品の追加・編集・削除ができます。MongoDB連携済み。
                    </div>
                    <a href="admin.html" class="action-button">開く</a>
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-header">
                    <i class="fas fa-chart-bar"></i> 分析画面
                </div>
                <div class="feature-content">
                    <div class="feature-description">
                        注文データの分析画面。時間帯別の注文数や商品別の売上などを確認できます。MongoDB連携済み。
                    </div>
                    <a href="analytics.html" class="action-button">開く</a>
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-header">
                    <i class="fas fa-concierge-bell"></i> ホールスタッフ
                </div>
                <div class="feature-content">
                    <div class="feature-description">
                        ホールスタッフ向けの注文状況確認画面。テーブル別の注文状況を一覧表示します。MongoDB連携済み。
                    </div>
                    <a href="hall_staff.html" class="action-button">開く</a>
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-header">
                    <i class="fas fa-vial"></i> 接続テスト
                </div>
                <div class="feature-content">
                    <div class="feature-description">
                        MongoDB接続テストページ。接続状態やパラメータを確認できます。デバッグ用。
                    </div>
                    <a href="mongo_test_standalone.html" class="action-button">開く</a>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // MongoDB設定
        const mongoConfig = {
            uri: "mongodb+srv://cluster0.5gmgchv.mongodb.net/?authSource=%24external&authMechanism=MONGODB-X509&retryWrites=true&w=majority&appName=Cluster0",
            dbName: "genbapower",
            options: {
                tlsCertificateKeyFile: "/Users/haradamitsuru/Downloads/X509-cert-4928065383930939451.pem"
            }
        };
        
        // 接続状態
        let dbClient = null;
        let dbAvailable = false;
        let dbTested = false;
        let connectionListeners = [];
        
        // 要素の取得
        const dbStatusElement = document.getElementById('db-status');
        const statusDetailsElement = document.getElementById('status-details');
        const logContainer = document.getElementById('log-container');
        const testConnectionButton = document.getElementById('test-connection');
        const showDetailsButton = document.getElementById('show-details');
        
        // 接続状態変更リスナーを追加
        function addConnectionListener(listener) {
            connectionListeners.push(listener);
        }
        
        // 接続状態変更時に全リスナーに通知
        function notifyConnectionListeners(available) {
            connectionListeners.forEach(listener => {
                try {
                    listener(available);
                } catch (err) {
                    console.error('接続リスナーエラー:', err);
                }
            });
        }
        
        // 接続状態を取得
        function getConnectionState() {
            return {
                available: dbAvailable,
                tested: dbTested,
                config: {
                    uri: mongoConfig.uri,
                    dbName: mongoConfig.dbName
                }
            };
        }
        
        // MongoDB接続テスト
        async function testConnection() {
            if (dbTested) {
                console.log('DB接続は既にテスト済み:', dbAvailable ? '接続成功' : '接続失敗');
                return dbAvailable;
            }
            
            console.log('MongoDB接続確認中...');
            addLog('MongoDB接続を確認中...');
            
            try {
                // モックのMongoDBクライアント（ブラウザ環境用）
                const mockMongoClient = {
                    uri: mongoConfig.uri,
                    options: mongoConfig.options,
                    
                    connect: async function() {
                        addLog('MongoDB接続を試みています...');
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        addLog('モックMongoDB接続成功');
                        return this;
                    },
                    
                    db: function(dbName) {
                        addLog(`データベース "${dbName}" にアクセス中`);
                        return {
                            collection: function(collectionName) {
                                addLog(`コレクション "${collectionName}" にアクセス中`);
                                return {
                                    find: function() { return { toArray: async () => [] }; },
                                    findOne: async function() { return null; },
                                    insertOne: async function(doc) { return { insertedId: 'mock-id' }; },
                                    updateOne: async function() { return { modifiedCount: 1 }; },
                                    deleteOne: async function() { return { deletedCount: 1 }; }
                                };
                            }
                        };
                    },
                    
                    close: async function() {
                        addLog('MongoDB接続を閉じています');
                        return true;
                    }
                };
                
                // 接続テスト
                dbClient = await mockMongoClient.connect();
                const db = dbClient.db(mongoConfig.dbName);
                await db.collection('orders').find().toArray();
                
                // 接続成功
                dbAvailable = true;
                dbTested = true;
                
                // リスナーに通知
                notifyConnectionListeners(true);
                
                return true;
            } catch (err) {
                // 接続失敗
                console.error('MongoDB接続テストエラー:', err);
                addLog(`MongoDB接続テストエラー: ${err.message}`, 'error-text');
                
                dbAvailable = false;
                dbTested = true;
                
                // リスナーに通知
                notifyConnectionListeners(false);
                
                return false;
            }
        }
        
        // 接続状態を表示する関数
        function updateDbStatus(status, message) {
            dbStatusElement.className = `db-status ${status}`;
            
            if (status === 'connected') {
                dbStatusElement.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            } else if (status === 'disconnected') {
                dbStatusElement.innerHTML = `<i class="fas fa-times-circle"></i> ${message}`;
            } else if (status === 'pending') {
                dbStatusElement.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${message}`;
            }
        }
        
        // ログエントリを追加する関数
        function addLog(message, type = 'info') {
            const now = new Date();
            const timestamp = now.toLocaleTimeString('ja-JP');
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // 接続詳細を表示する関数
        function showConnectionDetails() {
            const state = getConnectionState();
            
            // 接続詳細のHTMLを構築
            let detailsHtml = `
                <div class="status-item">
                    <div class="status-icon ${state.available ? 'success-icon' : 'error-icon'}">
                        <i class="fas ${state.available ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                    </div>
                    <div>接続状態: ${state.available ? '接続済み' : '未接続'}</div>
                </div>
                <div class="status-item">
                    <div class="status-icon">
                        <i class="fas fa-server"></i>
                    </div>
                    <div>MongoDB URI: ${state.config.uri}</div>
                </div>
                <div class="status-item">
                    <div class="status-icon">
                        <i class="fas fa-database"></i>
                    </div>
                    <div>データベース名: ${state.config.dbName}</div>
                </div>
                <div class="status-item">
                    <div class="status-icon">
                        <i class="fas fa-globe"></i>
                    </div>
                    <div>環境: ${typeof window !== 'undefined' ? 'ブラウザ' : 'Node.js'}</div>
                </div>
            `;
            
            // 詳細を表示
            statusDetailsElement.innerHTML = detailsHtml;
        }
        
        // 接続テストボタンのイベントリスナー
        testConnectionButton.addEventListener('click', async function() {
            // ボタンを一時的に無効化
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> テスト中...';
            
            // 接続状態表示を更新
            updateDbStatus('pending', 'MongoDB接続テスト実行中...');
            
            // ログにテスト開始メッセージを表示
            addLog('===== MongoDB接続テスト開始 =====');
            addLog('MongoDB接続を確認中...');
            
            try {
                // 接続テスト実行
                const isConnected = await testConnection();
                
                // テスト結果をログに表示
                if (isConnected) {
                    updateDbStatus('connected', 'MongoDB接続済み');
                    addLog('✅ MongoDB接続テスト成功!', 'info');
                    addLog(`データベースに正常に接続できました: ${mongoConfig.dbName}`, 'info');
                } else {
                    updateDbStatus('disconnected', 'MongoDB接続失敗');
                    addLog('❌ MongoDB接続テスト失敗', 'error-text');
                    addLog('データベースに接続できません。ローカルストレージを使用します。', 'warning');
                    addLog('DB設定を確認してください。', 'warning');
                }
                
                // 接続詳細を表示
                showConnectionDetails();
                
                // テスト完了メッセージ
                addLog('===== MongoDB接続テスト完了 =====');
            } catch (error) {
                updateDbStatus('disconnected', 'MongoDB接続エラー');
                addLog(`MongoDB接続テストエラー: ${error.message}`, 'error-text');
            } finally {
                // ボタンを元に戻す
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-vial"></i> 接続テスト';
            }
        });
        
        // 詳細表示ボタンのイベントリスナー
        showDetailsButton.addEventListener('click', function() {
            showConnectionDetails();
        });
        
        // 接続状態変更リスナーを登録
        addConnectionListener((available) => {
            if (available) {
                updateDbStatus('connected', 'MongoDB接続済み');
                addLog('MongoDB接続状態が変更されました: 接続済み', 'info');
            } else {
                updateDbStatus('disconnected', 'MongoDB接続失敗');
                addLog('MongoDB接続状態が変更されました: 未接続', 'warning');
            }
        });
        
        // ページ読み込み時に接続状態を確認
        async function initConnection() {
            addLog('MongoDB接続状態を確認中...');
            
            try {
                const isConnected = await testConnection();
                
                if (isConnected) {
                    updateDbStatus('connected', 'MongoDB接続済み');
                    addLog('MongoDB接続成功', 'info');
                } else {
                    updateDbStatus('disconnected', 'MongoDB接続失敗');
                    addLog('MongoDB接続失敗 - ローカルストレージにフォールバックします', 'warning');
                }
                
                // 詳細を表示
                showConnectionDetails();
            } catch (error) {
                updateDbStatus('disconnected', 'MongoDB接続エラー');
                addLog(`MongoDB接続確認エラー: ${error.message}`, 'error-text');
            }
        }
        
        // 初期化
        initConnection();
    </script>
</body>
</html>