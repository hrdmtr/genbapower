<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB データ初期化</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .init-button {
            margin-top: 20px;
            background-color: #4DB33D;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .init-button:hover {
            background-color: #3b9a2f;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(77, 179, 61, 0.3);
        }
        
        .init-button:active {
            transform: translateY(0);
        }
        
        .actions {
            margin-top: 30px;
            display: flex;
            gap: 20px;
            flex-direction: column;
        }
        
        .action-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #4DB33D;
        }
        
        .action-card h3 {
            color: #4DB33D;
            margin-top: 0;
        }
        
        #log-output {
            height: 300px;
            overflow-y: auto;
            background-color: #1e1e1e;
            color: #ddd;
            font-family: 'Consolas', 'Monaco', monospace;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .log-message {
            margin-bottom: 8px;
        }
        
        .log-success {
            color: #4DB33D;
        }
        
        .log-error {
            color: #ff6b6b;
        }
        
        .log-info {
            color: #56c8ff;
        }
        
        .db-details {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .db-detail-card {
            flex: 1;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #ddd;
        }
        
        .db-detail-card h4 {
            margin-top: 0;
            color: #444;
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
        }
        
        .data-preview {
            max-height: 200px;
            overflow-y: auto;
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="db-connection-indicator" class="db-indicator">
        <i class="fas fa-database"></i> MongoDB: 接続確認中...
    </div>

    <div class="container">
        <header class="header">
            <h1>MongoDB データ初期化ツール <span class="mongodb-badge">MongoDB</span></h1>
            <div class="header-actions">
                <a href="index.html" class="back-link">メイン画面に戻る</a>
                <a href="admin.html" class="back-link">商品マスター管理に戻る</a>
            </div>
        </header>

        <div id="db-status" class="db-status pending">
            <i class="fas fa-spinner fa-spin"></i> データベース接続状態を確認中...
        </div>

        <div class="content">
            <p>このページでは、MongoDBデータベースの初期化や確認作業を行うことができます。</p>
            
            <div class="actions">
                <div class="action-card">
                    <h3>商品マスターデータの初期化</h3>
                    <p>MongoDB上の商品マスターデータを初期化します。これにより、あらかじめ定義された商品データがデータベースに登録されます。</p>
                    <button id="init-products" class="init-button">
                        <i class="fas fa-database"></i> 商品マスターを初期化
                    </button>
                </div>
                
                <div class="action-card">
                    <h3>現在のデータ確認</h3>
                    <p>MongoDB上の現在のデータを確認します。</p>
                    <button id="check-data" class="init-button" style="background-color: #3498db;">
                        <i class="fas fa-search"></i> データを確認
                    </button>
                    
                    <div class="db-details" id="db-details" style="display: none;">
                        <div class="db-detail-card">
                            <h4>商品マスター</h4>
                            <div id="product-count">商品数: 読み込み中...</div>
                            <div class="data-preview" id="product-preview">
                                データを読み込み中...
                            </div>
                        </div>
                        <div class="db-detail-card">
                            <h4>注文データ</h4>
                            <div id="order-count">注文数: 読み込み中...</div>
                            <div class="data-preview" id="order-preview">
                                データを読み込み中...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <h3>処理ログ</h3>
            <div id="log-output"></div>
        </div>
    </div>
    
    <script type="module">
        import { saveData, getData, removeData, checkConnection } from './db_storage.js';
        import { testConnection, getConnectionState, addConnectionListener } from './mongo_connection.js';
        
        // DB接続状態表示要素
        const dbStatusElement = document.getElementById('db-status');
        const dbIndicator = document.getElementById('db-connection-indicator');
        
        // ログ出力要素
        const logOutput = document.getElementById('log-output');
        
        // ボタン要素
        const initProductsButton = document.getElementById('init-products');
        const checkDataButton = document.getElementById('check-data');
        
        // データプレビュー要素
        const dbDetails = document.getElementById('db-details');
        const productCount = document.getElementById('product-count');
        const productPreview = document.getElementById('product-preview');
        const orderCount = document.getElementById('order-count');
        const orderPreview = document.getElementById('order-preview');
        
        // ログ表示関数
        function log(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-message log-${type}`;
            
            // タイムスタンプを追加
            const now = new Date();
            const timestamp = now.toLocaleTimeString();
            
            logEntry.textContent = `[${timestamp}] ${message}`;
            logOutput.appendChild(logEntry);
            
            // 自動スクロール
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        // 接続状態を表示する関数
        function updateDbStatus(status, message) {
            if (!dbStatusElement) return;
            
            dbStatusElement.className = `db-status ${status}`;
            
            if (status === 'connected') {
                dbStatusElement.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
                dbIndicator.innerHTML = `<i class="fas fa-database"></i> MongoDB: 接続済み`;
                dbIndicator.style.backgroundColor = '#4DB33D';
            } else if (status === 'disconnected') {
                dbStatusElement.innerHTML = `<i class="fas fa-times-circle"></i> ${message}`;
                dbIndicator.innerHTML = `<i class="fas fa-database"></i> MongoDB: 未接続`;
                dbIndicator.style.backgroundColor = '#e74c3c';
            } else if (status === 'pending') {
                dbStatusElement.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${message}`;
                dbIndicator.innerHTML = `<i class="fas fa-database"></i> MongoDB: 接続確認中...`;
                dbIndicator.style.backgroundColor = '#f39c12';
            }
        }
        
        // 接続状態リスナーをセットアップ
        addConnectionListener((available) => {
            if (available) {
                updateDbStatus('connected', 'MongoDB接続成功: データベース接続済み');
                log('MongoDB接続に成功しました', 'success');
                // ボタンを有効化
                initProductsButton.disabled = false;
                checkDataButton.disabled = false;
            } else {
                updateDbStatus('disconnected', 'MongoDB接続失敗: ローカルストレージを使用します');
                log('MongoDB接続に失敗しました', 'error');
                // ボタンを無効化
                initProductsButton.disabled = true;
                checkDataButton.disabled = true;
            }
        });
        
        // 商品マスターのデフォルトデータ
        const defaultProductMaster = {
            "P001": {
                name: "醤油ラーメン",
                price: 800,
                image: "images/shoyu_ramen.jpg",
                description: "当店自慢の醤油ベーススープに特製の中太麺が絡む一品"
            },
            "P002": {
                name: "味噌ラーメン",
                price: 850,
                image: "images/miso_ramen.jpg",
                description: "北海道産の味噌を使用した濃厚スープと太麺の組み合わせ"
            },
            "P003": {
                name: "塩ラーメン",
                price: 800,
                image: "images/shio_ramen.jpg",
                description: "あっさりとした塩味のスープに細麺が特徴の一杯"
            },
            "P004": {
                name: "とんこつラーメン",
                price: 900,
                image: "images/tonkotsu_ramen.jpg",
                description: "豚骨を長時間煮込んだ濃厚なスープに細麺を合わせた博多風"
            },
            "P005": {
                name: "つけ麺",
                price: 950,
                image: "images/tsukemen.jpg",
                description: "濃厚なスープに極太麺をつけて食べる人気メニュー"
            },
            "P006": {
                name: "チャーシュー丼",
                price: 400,
                image: "images/chashu_don.jpg",
                description: "特製チャーシューをご飯の上にたっぷりと"
            },
            "P007": {
                name: "餃子（6個）",
                price: 350,
                image: "images/gyoza.jpg",
                description: "手作りの皮に野菜と豚肉をたっぷり包んだ一品"
            },
            "P008": {
                name: "ビール",
                price: 500,
                image: "images/beer.jpg",
                description: "ラーメンとの相性抜群の冷えたビール"
            },
            // 追加商品
            "P009": {
                name: "ライス",
                price: 200,
                image: "images/rice.jpg",
                description: "ラーメンのお供に欠かせない白米"
            },
            "P010": {
                name: "唐揚げ",
                price: 450,
                image: "images/karaage.jpg",
                description: "外はカリッと中はジューシーな特製唐揚げ"
            },
            "P011": {
                name: "杏仁豆腐",
                price: 300,
                image: "images/annin_tofu.jpg",
                description: "まろやかな口当たりの杏仁豆腐"
            },
            "P012": {
                name: "ウーロン茶",
                price: 250,
                image: "images/oolong_tea.jpg",
                description: "さっぱりとした後味のウーロン茶"
            }
        };
        
        // 初期データをMongoDBに登録する関数
        async function initializeProductData() {
            log('商品マスター初期化を開始します...', 'info');
            
            try {
                // MongoDB接続確認
                const connected = getConnectionState().available;
                
                if (connected) {
                    log('MongoDB接続OK - データを登録します', 'success');
                    
                    // 既存データを確認
                    const existingData = await getData('productMaster', 'products');
                    if (existingData) {
                        log(`既存の商品データが見つかりました: ${Object.keys(existingData).length}件`, 'info');
                        
                        if (!confirm('既存の商品データを上書きしますか？')) {
                            log('初期化処理をキャンセルしました', 'info');
                            return false;
                        }
                    }
                    
                    try {
                        // productMasterとして商品データを登録
                        await saveData('productMaster', defaultProductMaster, 'products');
                        log('商品マスターデータの登録が完了しました', 'success');
                        
                        // 登録した商品数をログ表示
                        const productCount = Object.keys(defaultProductMaster).length;
                        log(`登録した商品数: ${productCount}件`, 'success');
                        
                        // 各商品の画像パスを確認
                        log('商品画像パスの確認:', 'info');
                        for (const [productId, product] of Object.entries(defaultProductMaster)) {
                            // 画像の存在確認を試みる
                            const img = new Image();
                            img.onload = () => {
                                log(`${productId}: ${product.name} - 画像パス: ${product.image} (✓)`, 'success');
                            };
                            img.onerror = () => {
                                log(`${productId}: ${product.name} - 画像パス: ${product.image} (画像が見つかりません)`, 'error');
                            };
                            img.src = product.image;
                        }
                    } catch (saveError) {
                        log(`データ保存中にエラーが発生しました: ${saveError.message}`, 'error');
                        console.error('保存エラー:', saveError);
                        return false;
                    }
                    
                    return true;
                } else {
                    log('MongoDB接続に失敗しています。データは登録されませんでした。', 'error');
                    return false;
                }
            } catch (error) {
                log(`データ初期化中にエラーが発生しました: ${error.message}`, 'error');
                console.error('初期化エラー:', error);
                return false;
            }
        }
        
        // 現在のデータを確認する関数
        async function checkCurrentData() {
            log('現在のデータを確認しています...', 'info');
            dbDetails.style.display = 'flex';
            
            try {
                // MongoDB接続確認
                const connected = getConnectionState().available;
                
                if (connected) {
                    log('MongoDB接続OK - データを確認します', 'success');
                    
                    // 商品マスターデータを取得
                    const productData = await getData('productMaster', 'products');
                    if (productData) {
                        const productKeys = Object.keys(productData);
                        productCount.textContent = `商品数: ${productKeys.length}件`;
                        log(`商品マスターデータ: ${productKeys.length}件`, 'success');
                        
                        // 商品データのプレビュー表示
                        let previewHtml = '';
                        for (const [productId, product] of Object.entries(productData)) {
                            previewHtml += `<div>${productId}: ${product.name} - ¥${product.price}</div>`;
                        }
                        productPreview.innerHTML = previewHtml;
                    } else {
                        productCount.textContent = '商品数: 0件';
                        productPreview.innerHTML = 'データがありません';
                        log('商品マスターデータは存在しません', 'info');
                    }
                    
                    // 注文データを取得
                    const orderData = await getData('orders', 'orders');
                    if (orderData && Array.isArray(orderData)) {
                        orderCount.textContent = `注文数: ${orderData.length}件`;
                        log(`注文データ: ${orderData.length}件`, 'success');
                        
                        // 注文データのプレビュー表示
                        let orderHtml = '';
                        for (let i = 0; i < Math.min(5, orderData.length); i++) {
                            const order = orderData[i];
                            orderHtml += `<div>ID: ${order.id}, テーブル: ${order.tableId}, 商品数: ${order.items.length}点, ステータス: ${order.status}</div>`;
                        }
                        if (orderData.length > 5) {
                            orderHtml += `<div>...他 ${orderData.length - 5}件</div>`;
                        }
                        orderPreview.innerHTML = orderHtml || 'データがありません';
                    } else {
                        orderCount.textContent = '注文数: 0件';
                        orderPreview.innerHTML = 'データがありません';
                        log('注文データは存在しません', 'info');
                    }
                    
                    return true;
                } else {
                    log('MongoDB接続に失敗しています。データを確認できません。', 'error');
                    productCount.textContent = '商品数: 確認できません';
                    productPreview.innerHTML = 'MongoDB接続エラー';
                    orderCount.textContent = '注文数: 確認できません';
                    orderPreview.innerHTML = 'MongoDB接続エラー';
                    return false;
                }
            } catch (error) {
                log(`データ確認中にエラーが発生しました: ${error.message}`, 'error');
                console.error('確認エラー:', error);
                return false;
            }
        }
        
        // ボタンイベントリスナー
        initProductsButton.addEventListener('click', async () => {
            initProductsButton.disabled = true;
            let success = false;
            try {
                success = await initializeProductData();
                if (success) {
                    log('商品マスターの初期化が完了しました', 'success');
                } else {
                    log('商品マスターの初期化に失敗しました', 'error');
                }
            } catch (error) {
                log(`初期化処理中に予期しないエラーが発生しました: ${error.message}`, 'error');
                console.error('予期しないエラー:', error);
            } finally {
                initProductsButton.disabled = false;
            }
        });
        
        checkDataButton.addEventListener('click', async () => {
            checkDataButton.disabled = true;
            let success = false;
            try {
                success = await checkCurrentData();
                if (success) {
                    log('データ確認が完了しました', 'success');
                } else {
                    log('データ確認に失敗しました', 'error');
                }
            } catch (error) {
                log(`データ確認中に予期しないエラーが発生しました: ${error.message}`, 'error');
                console.error('予期しないエラー:', error);
            } finally {
                checkDataButton.disabled = false;
            }
        });
        
        // 初期化処理
        async function initialize() {
            updateDbStatus('pending', 'MongoDB接続を確認中...');
            log('MongoDB接続確認中...', 'info');
            
            // MongoDB接続テスト
            try {
                // 接続テスト（3回までリトライ）
                let connected = false;
                let retryCount = 0;
                const maxRetries = 3;
                
                while (!connected && retryCount < maxRetries) {
                    try {
                        await testConnection();
                        connected = true;
                    } catch (connError) {
                        retryCount++;
                        log(`MongoDB接続試行 ${retryCount}/${maxRetries} 失敗: ${connError.message}`, 'error');
                        
                        if (retryCount < maxRetries) {
                            log(`${retryCount}秒後に再試行します...`, 'info');
                            await new Promise(resolve => setTimeout(resolve, retryCount * 1000));
                        }
                    }
                }
                
                // 接続状態の取得と表示は、addConnectionListenerで処理される
                
                // 初期データ確認
                try {
                    const initialCheck = await checkCurrentData();
                    if (initialCheck) {
                        log('初期データ確認完了', 'success');
                    } else {
                        log('初期データ確認は接続問題のため完了できませんでした', 'error');
                    }
                } catch (dataError) {
                    log(`初期データ確認中にエラーが発生しました: ${dataError.message}`, 'error');
                    console.error('データ確認エラー:', dataError);
                }
            } catch (error) {
                log(`初期化中にエラーが発生しました: ${error.message}`, 'error');
                updateDbStatus('disconnected', 'MongoDB接続エラー: ' + error.message);
                console.error('初期化エラー:', error);
            }
        }
        
        // ページ読み込み時に初期化
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>