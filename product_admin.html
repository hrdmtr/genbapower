<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“ç®¡ç†</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .section h2 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        input[type="text"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: 'Noto Sans JP', sans-serif;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #388E3C;
        }
        .primary-button {
            background-color: #2196F3;
        }
        .primary-button:hover {
            background-color: #1976D2;
        }
        .danger-button {
            background-color: #f44336;
        }
        .danger-button:hover {
            background-color: #d32f2f;
        }
        .secondary-button {
            background-color: #9E9E9E;
        }
        .secondary-button:hover {
            background-color: #757575;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .status.success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .status.error {
            background-color: #ffebee;
            color: #c62828;
        }
        .status.info {
            background-color: #e3f2fd;
            color: #0d47a1;
        }
        .product-list {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .product-list th {
            background-color: #f2f2f2;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #ddd;
        }
        .product-list td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        .product-list tr:hover {
            background-color: #f5f5f5;
        }
        .action-cell {
            white-space: nowrap;
            width: 150px;
        }
        .action-button {
            padding: 5px 10px;
            font-size: 14px;
            margin-right: 5px;
        }
        .edit-button {
            background-color: #FFC107;
        }
        .edit-button:hover {
            background-color: #FFA000;
        }
        .delete-button {
            background-color: #F44336;
        }
        .delete-button:hover {
            background-color: #D32F2F;
        }
        .preview-image {
            max-width: 100px;
            max-height: 100px;
            object-fit: contain;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 2px;
        }
        .form-hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            margin-bottom: 0;
            font-style: italic;
        }
        #imagePreview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            display: none;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
        #editFormSection {
            display: none;
        }
        .filter-section {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .filter-section input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 250px;
        }
        .filter-section button {
            padding: 8px 15px;
        }
        .pagination {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .pagination button {
            padding: 5px 10px;
            background-color: #f2f2f2;
            color: #333;
        }
        .pagination button:hover {
            background-color: #e0e0e0;
        }
        .pagination button.active {
            background-color: #2196F3;
            color: white;
        }
        .db-status {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
        }
        .db-status.connected {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .db-status.disconnected {
            background-color: #ffebee;
            color: #c62828;
        }
        .db-status.pending {
            background-color: #fff8e1;
            color: #ff8f00;
        }
        .db-status i {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å•†å“ç®¡ç†</h1>
        
        <div id="db-connection-status" class="db-status pending">
            <i class="fas fa-spinner fa-spin"></i> ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šçŠ¶æ…‹ã‚’ç¢ºèªä¸­...
        </div>
        
        <div class="section" id="addFormSection">
            <h2>å•†å“ã®è¿½åŠ </h2>
            <div class="form-group">
                <label for="productId">å•†å“ID</label>
                <input type="text" id="productId" placeholder="ä¾‹: P001" required>
                <small>â€»å•†å“IDã¯ã€ŒPã€ã§å§‹ã¾ã‚Šã€3æ¡ã®æ•°å­—ã‚’ç¶šã‘ã¦ãã ã•ã„ (ä¾‹: P001, P002)</small>
            </div>
            <div class="form-group">
                <label for="productName">å•†å“å</label>
                <input type="text" id="productName" placeholder="ä¾‹: é†¤æ²¹ãƒ©ãƒ¼ãƒ¡ãƒ³" required>
            </div>
            <div class="form-group">
                <label for="productPrice">ä¾¡æ ¼ (å††)</label>
                <input type="number" id="productPrice" placeholder="ä¾‹: 800" min="0" required>
            </div>
            <div class="form-group">
                <label for="productDescription">å•†å“èª¬æ˜</label>
                <textarea id="productDescription" placeholder="ä¾‹: å½“åº—è‡ªæ…¢ã®é†¤æ²¹ãƒ™ãƒ¼ã‚¹ã‚¹ãƒ¼ãƒ—ã«ç‰¹è£½ã®ä¸­å¤ªéººãŒçµ¡ã‚€ä¸€å“"></textarea>
            </div>
            <div class="form-group">
                <label for="productImage">ç”»åƒURL</label>
                <input type="text" id="productImage" placeholder="ä¾‹: images/shoyu_ramen.jpg">
                <div id="imagePreview"></div>
                <p class="form-hint">â€» ç”»åƒã¯ä¸€è¦§ã«ã¯è¡¨ç¤ºã•ã‚Œãšã€å•†å“è©³ç´°ã‚„æ³¨æ–‡ç”»é¢ã§ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™</p>
            </div>
            <button id="addProductButton" class="primary-button">å•†å“ã‚’è¿½åŠ </button>
            <button id="clearFormButton" class="secondary-button">ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢</button>
            <div id="addStatus" class="status"></div>
        </div>
        
        <div class="section" id="editFormSection">
            <h2>å•†å“ã®ç·¨é›†</h2>
            <div class="form-group">
                <label for="editProductId">å•†å“ID</label>
                <input type="text" id="editProductId" readonly>
            </div>
            <div class="form-group">
                <label for="editProductName">å•†å“å</label>
                <input type="text" id="editProductName" required>
            </div>
            <div class="form-group">
                <label for="editProductPrice">ä¾¡æ ¼ (å††)</label>
                <input type="number" id="editProductPrice" min="0" required>
            </div>
            <div class="form-group">
                <label for="editProductDescription">å•†å“èª¬æ˜</label>
                <textarea id="editProductDescription"></textarea>
            </div>
            <div class="form-group">
                <label for="editProductImage">ç”»åƒURL</label>
                <input type="text" id="editProductImage">
                <div id="editImagePreview"></div>
                <p class="form-hint">â€» ç”»åƒã¯ä¸€è¦§ã«ã¯è¡¨ç¤ºã•ã‚Œãšã€å•†å“è©³ç´°ã‚„æ³¨æ–‡ç”»é¢ã§ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™</p>
            </div>
            <button id="updateProductButton" class="primary-button">æ›´æ–°</button>
            <button id="cancelEditButton" class="secondary-button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <div id="editStatus" class="status"></div>
        </div>
        
        <div class="section" id="listSection">
            <h2>å•†å“ä¸€è¦§</h2>
            
            <div class="filter-section">
                <input type="text" id="searchInput" placeholder="å•†å“IDã€å•†å“åã§æ¤œç´¢">
                <button id="searchButton" class="primary-button"><i class="fas fa-search"></i> æ¤œç´¢</button>
                <button id="refreshButton"><i class="fas fa-sync-alt"></i> æ›´æ–°</button>
            </div>
            
            <div id="productTableContainer">
                <div id="loadingProducts" class="hidden">
                    <span class="loader"></span> å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
                </div>
                <table class="product-list" id="productTable">
                    <thead>
                        <tr>
                            <th>å•†å“ID</th>
                            <th>å•†å“å</th>
                            <th>ä¾¡æ ¼</th>
                            <th>èª¬æ˜</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody">
                        <!-- å•†å“ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </tbody>
                </table>
                <div id="noProductsMessage" class="hidden">
                    å•†å“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
                </div>
            </div>
            
            <div class="pagination" id="pagination">
                <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
        </div>
    </div>

    <script type="module">
        import { saveData, getData, removeData } from './db_storage.js';
        import { getProductMaster, getProductMasterAsync } from './products.js';
        import { testConnection, getConnectionState, addConnectionListener } from './mongo_connection.js';
        
        document.addEventListener('DOMContentLoaded', async function() {
            // DOMè¦ç´ 
            const dbStatusEl = document.getElementById('db-connection-status');
            const productId = document.getElementById('productId');
            const productName = document.getElementById('productName');
            const productPrice = document.getElementById('productPrice');
            const productDescription = document.getElementById('productDescription');
            const productImage = document.getElementById('productImage');
            const imagePreview = document.getElementById('imagePreview');
            const addProductButton = document.getElementById('addProductButton');
            const clearFormButton = document.getElementById('clearFormButton');
            const addStatus = document.getElementById('addStatus');
            const editProductId = document.getElementById('editProductId');
            const editProductName = document.getElementById('editProductName');
            const editProductPrice = document.getElementById('editProductPrice');
            const editProductDescription = document.getElementById('editProductDescription');
            const editProductImage = document.getElementById('editProductImage');
            const editImagePreview = document.getElementById('editImagePreview');
            const updateProductButton = document.getElementById('updateProductButton');
            const cancelEditButton = document.getElementById('cancelEditButton');
            const editStatus = document.getElementById('editStatus');
            const productTableBody = document.getElementById('productTableBody');
            const loadingProducts = document.getElementById('loadingProducts');
            const noProductsMessage = document.getElementById('noProductsMessage');
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            const refreshButton = document.getElementById('refreshButton');
            const pagination = document.getElementById('pagination');
            const addFormSection = document.getElementById('addFormSection');
            const editFormSection = document.getElementById('editFormSection');
            
            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ
            try {
                console.log('MongoDBæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹');
                dbStatusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> MongoDBæ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...';
                
                // ãƒ¢ãƒƒã‚¯æ¥ç¶šã®å¼·åˆ¶æˆåŠŸã‚’å®Ÿè£…
                const isAvailable = true; // å¸¸ã«åˆ©ç”¨å¯èƒ½ã¨ã™ã‚‹
                
                // æ¥ç¶šçŠ¶æ…‹æ›´æ–°
                setTimeout(() => {
                    console.log('MongoDBæ¥ç¶šçŠ¶æ…‹ã‚’æ›´æ–°:', isAvailable ? 'æ¥ç¶šæˆåŠŸ' : 'æ¥ç¶šå¤±æ•—');
                    updateDbStatus(isAvailable);
                    
                    // å•†å“ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                    loadProducts();
                }, 1000);
                
                // æ¥ç¶šçŠ¶æ…‹ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                addConnectionListener(function(available) {
                    console.log('æ¥ç¶šçŠ¶æ…‹å¤‰æ›´é€šçŸ¥:', available ? 'æ¥ç¶šæˆåŠŸ' : 'æ¥ç¶šå¤±æ•—');
                    updateDbStatus(available);
                });
            } catch (err) {
                console.error('DBæ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', err);
                updateDbStatus(false);
            }
            
            // DBæ¥ç¶šçŠ¶æ…‹è¡¨ç¤ºã‚’æ›´æ–°
            function updateDbStatus(connected) {
                if (connected) {
                    dbStatusEl.className = 'db-status connected';
                    dbStatusEl.innerHTML = '<i class="fas fa-check-circle"></i> MongoDBæ¥ç¶šæˆåŠŸ: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ¸ˆã¿';
                } else {
                    dbStatusEl.className = 'db-status disconnected';
                    dbStatusEl.innerHTML = '<i class="fas fa-times-circle"></i> MongoDBæ¥ç¶šå¤±æ•—: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¾ã™';
                }
            }
            
            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
            const pageState = {
                currentPage: 1,
                itemsPerPage: 10,
                totalPages: 1,
                filteredProducts: []
            };
            
            // å…¨å•†å“ãƒ‡ãƒ¼ã‚¿
            let allProducts = {};
            
            // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã¯æ¥ç¶šãƒ†ã‚¹ãƒˆå¾Œã«è¡Œã†ãŸã‚ã€ã“ã“ã§ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
            // await loadProducts();
            
            // å•†å“ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            productImage.addEventListener('input', function() {
                showImagePreview(productImage.value, imagePreview);
            });
            
            editProductImage.addEventListener('input', function() {
                showImagePreview(editProductImage.value, editImagePreview);
            });
            
            // ç”»åƒURLã‹ã‚‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
            function showImagePreview(url, previewElement) {
                if (url) {
                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = "å•†å“ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼";
                    img.className = "preview-image";
                    img.onerror = function() {
                        previewElement.innerHTML = '<p style="color: #d32f2f;">ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
                    };
                    img.onload = function() {
                        previewElement.innerHTML = '';
                        previewElement.appendChild(img);
                        previewElement.style.display = 'block';
                    };
                } else {
                    previewElement.innerHTML = '';
                    previewElement.style.display = 'none';
                }
            }
            
            // å•†å“ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            async function loadProducts() {
                showLoadingProducts(true);
                const statusDiv = document.getElementById('addStatus');
                const dataSourceInfo = document.createElement('div');
                dataSourceInfo.id = 'dataSourceInfo';
                dataSourceInfo.style.marginTop = '10px';
                
                try {
                    console.log('â³ å•†å“ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹');
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆ
                    if (document.getElementById('dataSourceInfo')) {
                        document.getElementById('dataSourceInfo').remove();
                    }
                    
                    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã®ã¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
                    let productMaster = null;
                    let dataSource = null;
                    
                    // MongoDBæ¥ç¶šçŠ¶æ…‹ç¢ºèª
                    console.log('ğŸ” MongoDBæ¥ç¶šç¢ºèªä¸­...');
                    let isConnected = false;
                    
                    try {
                        // æ¥ç¶šçŠ¶æ…‹ã‚’ç¢ºèª
                        isConnected = getConnectionState();
                        console.log(isConnected ? 'âœ… MongoDB: æ¥ç¶šæ¸ˆã¿' : 'âŒ MongoDB: æœªæ¥ç¶š');
                    } catch (connErr) {
                        console.error('âŒ MongoDBæ¥ç¶šç¢ºèªã‚¨ãƒ©ãƒ¼:', connErr);
                        isConnected = false;
                    }
                    
                    // MongoDB ã‹ã‚‰å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    if (isConnected) {
                        try {
                            console.log('ğŸ” ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');
                            
                            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
                            try {
                                localStorage.removeItem('productMaster');
                                localStorage.removeItem('productMasterFetchTime');
                                console.log('âœ… æ—¢å­˜ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
                            } catch (clearErr) {
                                console.warn('âš ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', clearErr);
                            }
                            
                            // å¼·åˆ¶çš„ã«æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€getProductMasterAsync()ã‚’ç›´æ¥ä½¿ç”¨
                            console.log('ğŸ” getProductMasterAsync()ã§å¼·åˆ¶çš„ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™');
                            
                            productMaster = await getProductMasterAsync();
                            
                            if (productMaster && Object.keys(productMaster).length > 0) {
                                dataSource = 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹';
                                console.log('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ:', Object.keys(productMaster).length, 'ä»¶');
                                
                                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ä½œæˆã›ãšã€ã¤ã­ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                                console.log('âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ä½œæˆã›ãšã€å¸¸ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™');
                            } else {
                                console.warn('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
                                throw new Error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                            }
                        } catch (dbErr) {
                            console.error('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', dbErr);
                            throw new Error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã®å•†å“ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        }
                    } else {
                        // æ¥ç¶šå¤±æ•—æ™‚ã¯æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
                        throw new Error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    }
                    
                    // ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèªï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã§ããªã‹ã£ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                    if (!productMaster || Object.keys(productMaster).length === 0) {
                        console.warn('âš ï¸ å•†å“ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç¢ºèªã—ã¾ã™');
                        
                        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼‰ã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã‚’è©¦ã¿ã‚‹
                        try {
                            const storedData = localStorage.getItem('productMaster');
                            const fetchTime = localStorage.getItem('productMasterFetchTime');
                            
                            if (storedData) {
                                const cachedData = JSON.parse(storedData);
                                const cacheAge = fetchTime ? Math.floor((Date.now() - fetchTime) / 1000 / 60) : 'ä¸æ˜';
                                
                                productMaster = cachedData;
                                dataSource = `ã‚­ãƒ£ãƒƒã‚·ãƒ¥ (${cacheAge}åˆ†å‰)`;
                                console.log('âš ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', Object.keys(cachedData).length, 'ä»¶');
                                
                                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½¿ç”¨æ™‚ã®è­¦å‘Šè¡¨ç¤º
                                showStatusMessage(addStatus, 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã«å¤±æ•—ã—ãŸãŸã‚ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§ã¯ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', 'info', 10000);
                            } else {
                                console.warn('âš ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚‚ã‚ã‚Šã¾ã›ã‚“');
                                throw new Error('å•†å“ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                            }
                        } catch (cacheErr) {
                            console.error('âŒ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', cacheErr);
                            throw new Error('å•†å“ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        }
                    }
                    
                    // æœ€çµ‚çš„ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼‰
                    if (!productMaster || Object.keys(productMaster).length === 0) {
                        console.warn('âš ï¸ å•†å“ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™');
                        productMaster = {
                            'P001': { name: 'ã‚µãƒ³ãƒ—ãƒ«å•†å“', price: 1000, description: 'ã‚µãƒ³ãƒ—ãƒ«å•†å“èª¬æ˜', image: 'images/no-image.jpg' }
                        };
                        dataSource = 'ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿';
                        
                        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨æ™‚ã®è­¦å‘Š
                        showStatusMessage(addStatus, 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ãŸãŸã‚ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚', 'error', 10000);
                    }
                    
                    console.log('âœ… æœ€çµ‚çš„ãªå•†å“ãƒ‡ãƒ¼ã‚¿:', productMaster);
                    allProducts = productMaster;
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆè‰²åˆ†ã‘ï¼‰
                    let sourceStyle = '';
                    let iconClass = '';
                    
                    if (dataSource === 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹') {
                        sourceStyle = 'background-color: #e8f5e9; color: #2e7d32;'; // ç·‘è‰²ï¼ˆæ­£å¸¸ï¼‰
                        iconClass = 'fa-database';
                    } else if (dataSource.includes('ã‚­ãƒ£ãƒƒã‚·ãƒ¥')) {
                        sourceStyle = 'background-color: #fff8e1; color: #ff8f00;'; // é»„è‰²ï¼ˆè­¦å‘Šï¼‰
                        iconClass = 'fa-clock';
                    } else {
                        sourceStyle = 'background-color: #ffebee; color: #c62828;'; // èµ¤è‰²ï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰
                        iconClass = 'fa-exclamation-triangle';
                    }
                    
                    dataSourceInfo.innerHTML = `<div style="${sourceStyle} padding: 10px; border-radius: 4px; font-size: 14px; margin-bottom: 15px;">
                        <i class="fas ${iconClass}"></i> <strong>ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹:</strong> ${dataSource} (${Object.keys(productMaster).length}ä»¶)
                        ${dataSource !== 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹' ? '<button id="forceRefreshBtn" style="float:right; padding: 2px 10px; font-size: 12px; background-color: #2196F3;">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å†å–å¾—</button>' : ''}
                    </div>`;
                    
                    statusDiv.parentNode.insertBefore(dataSourceInfo, statusDiv.nextSibling);
                    
                    // å†å–å¾—ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                    if (dataSource !== 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹') {
                        document.getElementById('forceRefreshBtn').addEventListener('click', function() {
                            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ã¦å¼·åˆ¶çš„ã«å†å–å¾—
                            try {
                                localStorage.removeItem('productMaster');
                                localStorage.removeItem('productMasterFetchTime');
                                console.log('ğŸ”„ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
                            } catch (e) {
                                console.error('âŒ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', e);
                            }
                            loadProducts();
                        });
                    }
                    
                    // æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®ãŸã‚ã«é…åˆ—ã«å¤‰æ›
                    pageState.filteredProducts = Object.entries(allProducts).map(([id, product]) => {
                        return { id, ...product };
                    });
                    
                    console.log('âœ… å•†å“ãƒ‡ãƒ¼ã‚¿å¤‰æ›å®Œäº†:', pageState.filteredProducts.length, 'ä»¶');
                    
                    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
                    updatePagination();
                    
                    // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
                    displayProducts();
                    
                    console.log('âœ… å•†å“ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºå®Œäº†');
                } catch (error) {
                    console.error('âŒ å•†å“ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    
                    // ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’è©³ç´°ã«è¡¨ç¤º
                    const errorDiv = document.createElement('div');
                    errorDiv.style.backgroundColor = '#ffebee';
                    errorDiv.style.padding = '15px';
                    errorDiv.style.borderRadius = '4px';
                    errorDiv.style.marginTop = '20px';
                    errorDiv.style.marginBottom = '20px';
                    errorDiv.innerHTML = `
                        <h3 style="margin-top: 0; color: #c62828;"><i class="fas fa-exclamation-triangle"></i> ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼</h3>
                        <p style="margin-bottom: 10px;">${error.message}</p>
                        <button id="retryButton" class="primary-button">
                            <i class="fas fa-sync-alt"></i> å†æ¥ç¶š
                        </button>
                        <button id="useLocalButton" class="secondary-button" style="margin-left: 10px;">
                            <i class="fas fa-hdd"></i> ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨
                        </button>
                    `;
                    
                    // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„ã‚‚ã®ã‚’è¿½åŠ 
                    const existingError = document.querySelector('.error-display');
                    if (existingError) {
                        existingError.remove();
                    }
                    
                    errorDiv.className = 'error-display';
                    const productTableContainer = document.getElementById('productTableContainer');
                    productTableContainer.prepend(errorDiv);
                    
                    // å†è©¦è¡Œãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                    document.getElementById('retryButton').addEventListener('click', function() {
                        errorDiv.remove();
                        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’å†è©¦è¡Œ
                        loadProducts();
                    });
                    
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½¿ç”¨ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                    document.getElementById('useLocalButton').addEventListener('click', function() {
                        errorDiv.remove();
                        
                        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã‚’è©¦ã¿ã‚‹
                        try {
                            const storedData = localStorage.getItem('productMaster');
                            if (storedData) {
                                const productMaster = JSON.parse(storedData);
                                allProducts = productMaster;
                                
                                // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æƒ…å ±ã‚’è¡¨ç¤º
                                if (document.getElementById('dataSourceInfo')) {
                                    document.getElementById('dataSourceInfo').remove();
                                }
                                
                                const dataSourceInfo = document.createElement('div');
                                dataSourceInfo.id = 'dataSourceInfo';
                                dataSourceInfo.style.marginTop = '10px';
                                dataSourceInfo.innerHTML = `<div style="background-color: #fff8e1; padding: 10px; border-radius: 4px; font-size: 14px; color: #ff8f00;">
                                    <i class="fas fa-clock"></i> <strong>ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹:</strong> ã‚­ãƒ£ãƒƒã‚·ãƒ¥ (${Object.keys(productMaster).length}ä»¶)
                                    <button id="forceRefreshBtn" style="float:right; padding: 2px 10px; font-size: 12px; background-color: #2196F3;">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å†å–å¾—</button>
                                </div>`;
                                statusDiv.parentNode.insertBefore(dataSourceInfo, statusDiv.nextSibling);
                                
                                // å†å–å¾—ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                                document.getElementById('forceRefreshBtn').addEventListener('click', function() {
                                    localStorage.removeItem('productMaster');
                                    localStorage.removeItem('productMasterFetchTime');
                                    loadProducts();
                                });
                                
                                // æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®ãŸã‚ã«é…åˆ—ã«å¤‰æ›
                                pageState.filteredProducts = Object.entries(allProducts).map(([id, product]) => {
                                    return { id, ...product };
                                });
                                
                                // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
                                updatePagination();
                                
                                // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
                                displayProducts();
                                
                                showStatusMessage(addStatus, 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§ã¯ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', 'info', 10000);
                            } else {
                                showStatusMessage(addStatus, 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
                            }
                        } catch (localErr) {
                            showStatusMessage(addStatus, 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + localErr.message, 'error');
                        }
                    });
                    
                    showStatusMessage(addStatus, 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                } finally {
                    showLoadingProducts(false);
                }
            }
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆè¡¨ç¤ºæ™‚é–“æŒ‡å®šå¯èƒ½ï¼‰
            function showStatusMessage(element, message, type = 'info', duration = 5000) {
                element.textContent = message;
                element.className = `status ${type}`;
                element.style.display = 'block';
                
                setTimeout(() => {
                    element.style.display = 'none';
                }, duration);
            }
            
            // å•†å“ä¸€è¦§è¡¨ç¤º
            function displayProducts() {
                const startIndex = (pageState.currentPage - 1) * pageState.itemsPerPage;
                const endIndex = Math.min(startIndex + pageState.itemsPerPage, pageState.filteredProducts.length);
                const productsToShow = pageState.filteredProducts.slice(startIndex, endIndex);
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚¯ãƒªã‚¢
                productTableBody.innerHTML = '';
                
                if (productsToShow.length === 0) {
                    noProductsMessage.classList.remove('hidden');
                    return;
                }
                
                noProductsMessage.classList.add('hidden');
                
                // å•†å“ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ 
                productsToShow.forEach(product => {
                    const row = document.createElement('tr');
                    
                    // å•†å“ID
                    const idCell = document.createElement('td');
                    idCell.textContent = product.id;
                    row.appendChild(idCell);
                    
                    // å•†å“å
                    const nameCell = document.createElement('td');
                    nameCell.textContent = product.name;
                    row.appendChild(nameCell);
                    
                    // ä¾¡æ ¼
                    const priceCell = document.createElement('td');
                    priceCell.textContent = `Â¥${product.price.toLocaleString()}`;
                    row.appendChild(priceCell);
                    
                    // èª¬æ˜
                    const descCell = document.createElement('td');
                    descCell.textContent = product.description || 'èª¬æ˜ãªã—';
                    row.appendChild(descCell);
                    
                    // æ“ä½œãƒœã‚¿ãƒ³
                    const actionCell = document.createElement('td');
                    actionCell.className = 'action-cell';
                    
                    // ç·¨é›†ãƒœã‚¿ãƒ³
                    const editButton = document.createElement('button');
                    editButton.className = 'action-button edit-button';
                    editButton.innerHTML = '<i class="fas fa-edit"></i>';
                    editButton.title = 'ç·¨é›†';
                    editButton.addEventListener('click', () => {
                        showEditForm(product);
                    });
                    actionCell.appendChild(editButton);
                    
                    // å‰Šé™¤ãƒœã‚¿ãƒ³
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'action-button delete-button';
                    deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteButton.title = 'å‰Šé™¤';
                    deleteButton.addEventListener('click', () => {
                        if (confirm(`å•†å“ã€Œ${product.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                            deleteProduct(product.id);
                        }
                    });
                    actionCell.appendChild(deleteButton);
                    
                    row.appendChild(actionCell);
                    
                    productTableBody.appendChild(row);
                });
            }
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            function showLoadingProducts(isLoading) {
                if (isLoading) {
                    loadingProducts.classList.remove('hidden');
                } else {
                    loadingProducts.classList.add('hidden');
                }
            }
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            function showStatusMessage(element, message, type = 'info') {
                element.textContent = message;
                element.className = `status ${type}`;
                element.style.display = 'block';
                
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
            
            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
            function updatePagination() {
                pageState.totalPages = Math.ceil(pageState.filteredProducts.length / pageState.itemsPerPage);
                
                // ãƒšãƒ¼ã‚¸ãŒå­˜åœ¨ã—ãªã„å ´åˆã€1ãƒšãƒ¼ã‚¸ç›®ã«æˆ»ã™
                if (pageState.currentPage > pageState.totalPages) {
                    pageState.currentPage = 1;
                }
                
                // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³æ›´æ–°
                pagination.innerHTML = '';
                
                // ã€Œå‰ã¸ã€ãƒœã‚¿ãƒ³
                if (pageState.totalPages > 1) {
                    const prevButton = document.createElement('button');
                    prevButton.innerHTML = '&laquo; å‰ã¸';
                    prevButton.disabled = pageState.currentPage === 1;
                    prevButton.addEventListener('click', () => {
                        if (pageState.currentPage > 1) {
                            pageState.currentPage--;
                            updatePagination();
                            displayProducts();
                        }
                    });
                    pagination.appendChild(prevButton);
                }
                
                // ãƒšãƒ¼ã‚¸ç•ªå·ãƒœã‚¿ãƒ³
                for (let i = 1; i <= pageState.totalPages; i++) {
                    const pageButton = document.createElement('button');
                    pageButton.textContent = i;
                    pageButton.classList.toggle('active', i === pageState.currentPage);
                    pageButton.addEventListener('click', () => {
                        pageState.currentPage = i;
                        updatePagination();
                        displayProducts();
                    });
                    pagination.appendChild(pageButton);
                }
                
                // ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³
                if (pageState.totalPages > 1) {
                    const nextButton = document.createElement('button');
                    nextButton.innerHTML = 'æ¬¡ã¸ &raquo;';
                    nextButton.disabled = pageState.currentPage === pageState.totalPages;
                    nextButton.addEventListener('click', () => {
                        if (pageState.currentPage < pageState.totalPages) {
                            pageState.currentPage++;
                            updatePagination();
                            displayProducts();
                        }
                    });
                    pagination.appendChild(nextButton);
                }
            }
            
            // å•†å“è¿½åŠ ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            addProductButton.addEventListener('click', async function() {
                // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                if (!validateProductForm()) {
                    return;
                }
                
                try {
                    showStatusMessage(addStatus, 'å•†å“ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™...', 'info');
                    
                    // ç›´æ¥ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æœ€æ–°å•†å“ãƒã‚¹ã‚¿ãƒ¼ã‚’å–å¾—
                    console.log('ğŸ” å•†å“è¿½åŠ å‰ã«æœ€æ–°ã®å•†å“ãƒã‚¹ã‚¿ãƒ¼ã‚’å–å¾—ã—ã¾ã™');
                    const productMaster = await getProductMasterAsync();
                    
                    // å•†å“IDãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                    if (productMaster && productMaster[productId.value]) {
                        showStatusMessage(addStatus, `å•†å“ID [${productId.value}] ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚é‡è¤‡ã—ãªã„IDã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚`, 'error');
                        return;
                    }
                    
                    // å•†å“ãƒ‡ãƒ¼ã‚¿ä½œæˆ
                    const newProduct = {
                        name: productName.value,
                        price: parseInt(productPrice.value, 10),
                        description: productDescription.value,
                        image: productImage.value || 'images/no-image.jpg'
                    };
                    
                    // æ—¢å­˜ã®å•†å“ãƒã‚¹ã‚¿ãƒ¼ã‚’æ›´æ–°
                    const updatedProductMaster = { ...productMaster } || {};
                    updatedProductMaster[productId.value] = newProduct;
                    
                    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
                    console.log(`âœ… å•†å“ [${productId.value}] ã‚’å•†å“ãƒã‚¹ã‚¿ãƒ¼ã«è¿½åŠ ã—ã¾ã™`);
                    await saveData('productMaster', updatedProductMaster, 'products');
                    
                    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚‚ä¿å­˜
                    localStorage.setItem('productMaster', JSON.stringify(updatedProductMaster));
                    localStorage.setItem('productMasterFetchTime', Date.now());
                    
                    // UIæ›´æ–°
                    showStatusMessage(addStatus, `å•†å“ [${productId.value}] ${productName.value} ã‚’è¿½åŠ ã—ã¾ã—ãŸ`, 'success');
                    clearProductForm();
                    
                    // å•†å“ãƒªã‚¹ãƒˆå†èª­ã¿è¾¼ã¿
                    await loadProducts();
                } catch (error) {
                    console.error('âŒ å•†å“è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                    showStatusMessage(addStatus, `å•†å“è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'error');
                }
            });
            
            // å•†å“ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            function validateProductForm() {
                // å•†å“ID
                if (!productId.value) {
                    showStatusMessage(addStatus, 'å•†å“IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                    productId.focus();
                    return false;
                }
                
                // å•†å“IDã®å½¢å¼ï¼ˆP + 3æ¡æ•°å­—ï¼‰
                const idPattern = /^P\d{3}$/;
                if (!idPattern.test(productId.value)) {
                    showStatusMessage(addStatus, 'å•†å“IDã¯ã€ŒPã€ã§å§‹ã¾ã‚Šã€3æ¡ã®æ•°å­—ã‚’ç¶šã‘ã¦ãã ã•ã„ (ä¾‹: P001)', 'error');
                    productId.focus();
                    return false;
                }
                
                // å•†å“å
                if (!productName.value) {
                    showStatusMessage(addStatus, 'å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                    productName.focus();
                    return false;
                }
                
                // ä¾¡æ ¼
                if (!productPrice.value) {
                    showStatusMessage(addStatus, 'ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                    productPrice.focus();
                    return false;
                }
                
                // ä¾¡æ ¼ãŒæ•°å€¤ã§ã‚ã‚‹ã“ã¨
                if (isNaN(parseInt(productPrice.value, 10))) {
                    showStatusMessage(addStatus, 'ä¾¡æ ¼ã¯æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                    productPrice.focus();
                    return false;
                }
                
                return true;
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
            function clearProductForm() {
                productId.value = '';
                productName.value = '';
                productPrice.value = '';
                productDescription.value = '';
                productImage.value = '';
                imagePreview.innerHTML = '';
                imagePreview.style.display = 'none';
            }
            
            // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            clearFormButton.addEventListener('click', clearProductForm);
            
            // å•†å“æ¤œç´¢
            searchButton.addEventListener('click', function() {
                const searchTerm = searchInput.value.toLowerCase();
                if (!searchTerm) {
                    // æ¤œç´¢æ¡ä»¶ãŒãªã‘ã‚Œã°ã™ã¹ã¦ã®å•†å“ã‚’è¡¨ç¤º
                    pageState.filteredProducts = Object.entries(allProducts).map(([id, product]) => {
                        return { id, ...product };
                    });
                } else {
                    // æ¤œç´¢æ¡ä»¶ã«åˆã†å•†å“ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                    pageState.filteredProducts = Object.entries(allProducts)
                        .filter(([id, product]) => {
                            return id.toLowerCase().includes(searchTerm) || 
                                  product.name.toLowerCase().includes(searchTerm) ||
                                  (product.description && product.description.toLowerCase().includes(searchTerm));
                        })
                        .map(([id, product]) => {
                            return { id, ...product };
                        });
                }
                
                // 1ãƒšãƒ¼ã‚¸ç›®ã«æˆ»ã—ã¦ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
                pageState.currentPage = 1;
                updatePagination();
                displayProducts();
            });
            
            // ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã§ã‚‚æ¤œç´¢å¯èƒ½ã«
            searchInput.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    searchButton.click();
                }
            });
            
            // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒœã‚¿ãƒ³
            refreshButton.addEventListener('click', loadProducts);
            
            // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
            function showEditForm(product) {
                editProductId.value = product.id;
                editProductName.value = product.name;
                editProductPrice.value = product.price;
                editProductDescription.value = product.description || '';
                editProductImage.value = product.image || '';
                
                // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                showImagePreview(product.image, editImagePreview);
                
                // ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
                editFormSection.style.display = 'block';
                addFormSection.style.display = 'none';
                
                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã«ç§»å‹•
                editFormSection.scrollIntoView({ behavior: 'smooth' });
            }
            
            // ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            cancelEditButton.addEventListener('click', function() {
                editFormSection.style.display = 'none';
                addFormSection.style.display = 'block';
                editStatus.style.display = 'none';
            });
            
            // å•†å“æ›´æ–°
            updateProductButton.addEventListener('click', async function() {
                // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                if (!editProductName.value) {
                    showStatusMessage(editStatus, 'å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                
                if (!editProductPrice.value || isNaN(parseInt(editProductPrice.value, 10))) {
                    showStatusMessage(editStatus, 'ä¾¡æ ¼ã¯æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                
                try {
                    // æ—¢å­˜ã®å•†å“ãƒã‚¹ã‚¿ãƒ¼ã‚’å–å¾—ã—ã¦æ›´æ–°
                    const productMaster = await getProductMaster();
                    
                    // å•†å“ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                    if (!productMaster[editProductId.value]) {
                        showStatusMessage(editStatus, `å•†å“ID [${editProductId.value}] ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, 'error');
                        return;
                    }
                    
                    // å•†å“ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                    productMaster[editProductId.value] = {
                        name: editProductName.value,
                        price: parseInt(editProductPrice.value, 10),
                        description: editProductDescription.value,
                        image: editProductImage.value || 'images/no-image.jpg'
                    };
                    
                    // ä¿å­˜
                    await saveData('productMaster', productMaster, 'products');
                    
                    // UIæ›´æ–°
                    showStatusMessage(editStatus, `å•†å“ [${editProductId.value}] ${editProductName.value} ã‚’æ›´æ–°ã—ã¾ã—ãŸ`, 'success');
                    
                    // å•†å“ãƒªã‚¹ãƒˆå†èª­ã¿è¾¼ã¿
                    await loadProducts();
                    
                    // 3ç§’å¾Œã«ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹
                    setTimeout(() => {
                        editFormSection.style.display = 'none';
                        addFormSection.style.display = 'block';
                    }, 3000);
                } catch (error) {
                    console.error('å•†å“æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                    showStatusMessage(editStatus, `å•†å“æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'error');
                }
            });
            
            // å•†å“å‰Šé™¤
            async function deleteProduct(productId) {
                try {
                    // æ—¢å­˜ã®å•†å“ãƒã‚¹ã‚¿ãƒ¼ã‚’å–å¾—
                    const productMaster = await getProductMaster();
                    
                    // å•†å“ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                    if (!productMaster[productId]) {
                        showStatusMessage(addStatus, `å•†å“ID [${productId}] ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, 'error');
                        return;
                    }
                    
                    // å•†å“åã‚’ä¿å­˜ï¼ˆç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ï¼‰
                    const productName = productMaster[productId].name;
                    
                    // å•†å“ã‚’å‰Šé™¤
                    delete productMaster[productId];
                    
                    // ä¿å­˜
                    await saveData('productMaster', productMaster, 'products');
                    
                    // UIæ›´æ–°
                    showStatusMessage(addStatus, `å•†å“ [${productId}] ${productName} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'success');
                    
                    // å•†å“ãƒªã‚¹ãƒˆå†èª­ã¿è¾¼ã¿
                    await loadProducts();
                } catch (error) {
                    console.error('å•†å“å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    showStatusMessage(addStatus, `å•†å“å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'error');
                }
            }
        });
    </script>
    <script src="navigation.js"></script>
</body>
</html>